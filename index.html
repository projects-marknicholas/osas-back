<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .g_id_signin {
            margin: 20px 0;
        }
        #debug-info {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Admin Login</h1>
    
    <!-- Regular login form -->
    <form id="loginForm">
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
    
    <p>Or</p>
    
    <!-- Google Sign-In Button -->
    <div id="g_id_onload"
         data-client_id="801266690000-95gn9oj81vnnangke74bf5ff3dgj2t22.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleGoogleSignIn"
         data-auto_prompt="false">
    </div>
    
    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="filled_blue"
         data-text="signin_with"
         data-size="large"
         data-logo_alignment="left">
    </div>

    <!-- Debug information area -->
    <div id="debug-info">
        <h3>Debug Information:</h3>
        <pre id="debug-output"></pre>
    </div>

    <button onclick="toggleDebug()" style="margin-top: 20px;">Toggle Debug Info</button>

    <script>
        // Toggle debug information
        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // Handle regular form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            console.log("Regular login attempt with:", data);
            
            try {
                const response = await fetch('http://localhost/osas-back/callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log("Regular login result:", result);
                
                // Display debug info
                document.getElementById('debug-output').textContent = JSON.stringify(result, null, 2);
                document.getElementById('debug-info').style.display = 'block';
                
                if (result.success) {
                    // Store user data and redirect
                    localStorage.setItem('adminUser', JSON.stringify(result.user));
                    console.log("Stored user data:", result.user);
                    alert('Login successful! Check console for details.');
                    // window.location.href = '/admin-dashboard';
                } else {
                    alert('Login failed: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Login failed. Please try again.');
            }
        });
        
        // Handle Google Sign-In
        function handleGoogleSignIn(response) {
            console.log("Google Sign-In response received:", response);
            
            // Display the Google credential in debug area
            document.getElementById('debug-output').textContent = "Google Credential: " + response.credential;
            document.getElementById('debug-info').style.display = 'block';
            
            // Send the token to your server
            fetch('http://localhost/osas-back/callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ google_token: response.credential })
            })
            .then(response => {
                console.log("Server response status:", response.status);
                
                // First, check what the server is returning
                return response.text().then(text => {
                    console.log("Raw server response:", text);
                    
                    try {
                        const data = JSON.parse(text);
                        console.log("Parsed server response:", data);
                        return data;
                    } catch (e) {
                        console.error('Server returned non-JSON response:', text);
                        throw new Error('Server error: ' + text);
                    }
                });
            })
            .then(data => {
                // Display full response in debug area
                document.getElementById('debug-output').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    // Store user data and redirect
                    localStorage.setItem('adminUser', JSON.stringify(data.user));
                    console.log("Google login successful. User data:", data.user);
                    alert('Google login successful! Check console for details.');
                    // window.location.href = '/admin-dashboard';
                } else {
                    console.error("Google login failed:", data.error);
                    alert('Authentication failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Authentication failed. Please try again. Check console for details.');
            });
        }

        // Add event listener for Google button load
        window.onload = function() {
            console.log("Page loaded. Google Sign-In button should be available.");
        }
    </script>
</body>
</html>